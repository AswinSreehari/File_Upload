# backend/Dockerfile
FROM node:20-bullseye-slim

# Install minimal packages and LibreOffice headless
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates \
      ffmpeg \
      libreoffice-core \
      libreoffice-writer \
      libreoffice-impress \
      libreoffice-common \
      fonts-dejavu-core \
      fontconfig \
      wget \
      unzip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /usr/src/app

# Copy package files and install deps first (leverages Docker cache)
COPY package*.json ./

# Use legacy OpenSSL provider during npm install to avoid ERR_SSL_CIPHER issues
# This environment variable will be removed after install so runtime is normal.
ENV NODE_OPTIONS="--openssl-legacy-provider"
RUN npm ci --production
ENV NODE_OPTIONS=""

# Copy rest of backend source
COPY . .

# Ensure uploads/pdf dir exists and is writable
RUN mkdir -p ./uploads/pdfs && chown -R node:node ./uploads

# Use non-root node user (image base provides user=node)
USER node

# Expose port your app listens on (keep consistent with your app)
ENV PORT=5000
# Tell code where soffice is
ENV LIBREOFFICE_BIN=/usr/bin/soffice

# Healthcheck (optional)
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s \
  CMD curl -f http://localhost:5000/ || exit 1

# Start the server
CMD ["node", "server.js"]
